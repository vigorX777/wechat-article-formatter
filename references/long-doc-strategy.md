# 长文档处理策略

本文档描述长文档（>300 行）的分段转换流程与自动化验证机制，是避免内容丢失的核心机制。

---

## 第三步：结构指纹提取

**在开始转换之前**，必须先分析源 Markdown 文档，提取结构指纹：

| 指标 | 统计方式 | 示例 |
|------|----------|------|
| H2 标题 | 统计所有 `## ` 开头的行，记录标题文本列表 | `["背景介绍", "核心方法", "实验结果", "总结"]` |
| H3 标题 | 统计所有 `### ` 开头的行 | 数量：8 |
| 表格 | 统计每个表格的数据行数（不含表头和分隔行） | `[5, 12, 3]`（3 个表格，分别 5/12/3 行） |
| 列表项 | 统计每个连续列表块的项数 | `[6, 15, 4]` |
| 图片 | 统计 `![` 开头的行数 | 数量：7 |
| 总行数 | 文档总行数 | 428 |

将这些指标记录为 **结构指纹**，转换完成后用于自动验证。

---

## 第四步：转换策略选择

**转换策略根据文档长度自动选择：**

### 短文档（≤300 行）：一次性转换

直接将整篇文档转换为 HTML，包含完整的页面结构（外层容器、头部区域、内容区域、尾部）。

### 长文档（>300 行）：按 H2 分段转换

> ⚠️ **此流程是解决长文档内容丢失问题的核心机制，必须严格执行。**

**第一轮：生成页面骨架 + 前言**

转换以下内容，生成包含完整页面结构的 HTML：
- 外层容器 `<section>` 开标签
- 头部区域（渐变背景、标签、标题、副标题等）
- 白色内容卡片（**仅放一段精炼的核心观点或数据 hook**，不超过 2-3 句话。自我介绍、背景铺垫、过渡内容等放在卡片之后作为正文开头）
- 封面图占位符（如有）
- 正文分隔线（如有）
- **不关闭** 外层容器标签

输出时在末尾添加注释标记：`<!-- SEGMENT_BOUNDARY -->`

**第二轮起：逐段转换 H2 章节**

将源文档按 H2 标题（`## `）切分为独立段落。每个段落包含：
- 该 H2 标题
- 该 H2 下的所有内容（段落、列表、表格、代码块、图片等），直到下一个 H2 或文档末尾

逐段转换时：
1. 每段只输出该章节的 HTML 片段（不含页面骨架）
2. 保持图片占位符编号的全局连续性（如上一段用到 `WECHATIMGPH_3`，本段从 `WECHATIMGPH_4` 开始）
3. 每段末尾添加 `<!-- SEGMENT_BOUNDARY -->` 注释

**最后一轮：拼接与闭合**

将所有片段按顺序拼接，移除所有 `<!-- SEGMENT_BOUNDARY -->` 注释，关闭外层容器标签，生成完整 HTML。

---

## 第五步：自动化验证（必做）

转换完成后，**自动**（非人工）执行以下验证，对比结构指纹：

| 检查项 | 方法 | 不通过时的处理 |
|--------|------|----------------|
| H2 标题数量 | 统计生成 HTML 中的 H2 元素数，与原文 H2 列表逐一比对 | 定位缺失的 H2 标题，补充转换该章节 |
| H3 标题数量 | 统计生成 HTML 中的 H3 元素数 | 定位缺失的 H3，补充转换 |
| 表格行数 | 统计每个 `<table>` 中 `<tr>` 数量（减去表头行），与原文各表格行数对比 | 找到行数不足的表格，用原文数据补全 |
| 列表项数 | 统计 `<li>` 数量 | 找到截断的列表，补全缺失项 |
| 图片占位符数 | 统计 `WECHATIMGPH_` 出现次数 | 补充缺失的图片占位符 |

**验证流程**：
1. 执行上表所有检查项
2. 如果**全部通过** → 输出验证报告，继续下一步
3. 如果**有不通过项** → 自动修补（补充缺失内容），然后**重新验证**，直到全部通过
4. 验证报告格式：

```
✅ 验证通过
- H2 标题：原文 4 个 ↔ HTML 4 个 ✓
- H3 标题：原文 8 个 ↔ HTML 8 个 ✓
- 表格行数：原文 [5, 12, 3] ↔ HTML [5, 12, 3] ✓
- 列表项：原文 25 个 ↔ HTML 25 个 ✓
- 图片：原文 7 个 ↔ HTML 7 个 ✓
```
